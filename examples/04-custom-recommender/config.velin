// Custom Recommender - Konfiguration
// Lädt Einstellungen aus velin.config.json und Umgebungsvariablen

// Config-Struktur (entspricht velin.config.json)
struct AppConfig {
    api: ApiConfig,
    database: DatabaseConfig,
    ml: MLConfig,
    cache: CacheConfig,
    logging: LoggingConfig,
    security: SecurityConfig,
    wasm: WASMConfig,
}

struct ApiConfig {
    port: number,
    host: string,
    cors: CorsConfig,
}

struct CorsConfig {
    enabled: boolean,
    origins: List<string>,
}

struct DatabaseConfig {
    type: string,
    provider: string,
    connectionString: string,
    collections: Map<string, string>,
}

struct MLConfig {
    llm: LLMConfig,
    recommendation: RecommendationConfig,
}

struct LLMConfig {
    provider: string,
    apiKey: string,
    anthropicApiKey: string,
    geminiApiKey: string,
    model: string,
    anthropicModel: string,
    geminiModel: string,
    embeddingModel: string,
}

struct RecommendationConfig {
    embeddingWeight: number,
    collaborativeWeight: number,
    maxRecommendations: number,
    minScore: number,
}

struct CacheConfig {
    enabled: boolean,
    ttl: number,
    provider: string,
}

struct LoggingConfig {
    level: string,
    format: string,
    output: string,
}

struct SecurityConfig {
    apiKeyRequired: boolean,
    apiKeyHeader: string,
    jwt: JWTConfig,
    rateLimit: RateLimitConfig,
    cors: SecurityCorsConfig,
    https: HTTPSConfig,
    headers: SecurityHeadersConfig,
    inputValidation: InputValidationConfig,
}

struct RateLimitConfig {
    enabled: boolean,
    requestsPerMinute: number,
    burst: number,
}

struct JWTConfig {
    enabled: boolean,
    secret: string,
    expiration: number,
}

struct SecurityCorsConfig {
    allowedOrigins: List<string>,
    allowedMethods: List<string>,
    allowedHeaders: List<string>,
    maxAge: number,
}

struct HTTPSConfig {
    enabled: boolean,
    redirectHttp: boolean,
}

struct SecurityHeadersConfig {
    xFrameOptions: string,
    xContentTypeOptions: string,
    xXSSProtection: string,
    strictTransportSecurity: string,
}

struct InputValidationConfig {
    enabled: boolean,
    maxRequestSize: number,
    maxArrayLength: number,
}

struct WASMConfig {
    enabled: boolean,
    target: string,
    optimization: string,
    features: List<string>,
}

// Globale Config-Variable (wird beim Start geladen)
let mut appConfig: AppConfig;

// loadConfig - Lädt Konfiguration aus velin.config.json
// Ersetzt ${VAR_NAME} mit Umgebungsvariablen
fn loadConfig(): AppConfig {
    // In Production: Lade aus velin.config.json
    // Verwende JSON.parse() und env.get() für Umgebungsvariablen
    
    // Beispiel-Konfiguration (in Production aus Datei geladen)
    return AppConfig {
        api: ApiConfig {
            port: 8080,
            host: "localhost",
            cors: CorsConfig {
                enabled: true,
                origins: ["http://localhost:3000", "http://localhost:5173"],
            },
        },
        database: DatabaseConfig {
            type: "vector",
            provider: "local",
            connectionString: getEnv("VECTOR_DB_CONNECTION", "local://vectors"),
            collections: Map<string, string> {
                "items": "items",
                "users": "users",
            },
        },
        ml: MLConfig {
            llm: LLMConfig {
                provider: "openai",
                apiKey: getEnv("OPENAI_API_KEY", ""),
                anthropicApiKey: getEnv("ANTHROPIC_API_KEY", ""),
                geminiApiKey: getEnv("GOOGLE_GEMINI_API_KEY", ""),
                model: "gpt-4",
                anthropicModel: "claude-3-opus-20240229",
                geminiModel: "gemini-pro",
                embeddingModel: "text-embedding-ada-002",
            },
            recommendation: RecommendationConfig {
                embeddingWeight: 0.6,
                collaborativeWeight: 0.4,
                maxRecommendations: 50,
                minScore: 0.3,
            },
        },
        cache: CacheConfig {
            enabled: true,
            ttl: 3600,
            provider: "memory",
        },
        logging: LoggingConfig {
            level: getEnv("LOG_LEVEL", "info"),
            format: "json",
            output: "console",
        },
        security: SecurityConfig {
            apiKeyRequired: true,
            apiKeyHeader: "X-API-Key",
            jwt: JWTConfig {
                enabled: true,
                secret: getEnv("JWT_SECRET", ""),
                expiration: 3600,
            },
            rateLimit: RateLimitConfig {
                enabled: true,
                requestsPerMinute: 100,
                burst: 20,
            },
            cors: SecurityCorsConfig {
                allowedOrigins: ["http://localhost:3000"],
                allowedMethods: ["GET", "POST", "PUT", "DELETE"],
                allowedHeaders: ["Content-Type", "Authorization", "X-API-Key"],
                maxAge: 3600,
            },
            https: HTTPSConfig {
                enabled: true,
                redirectHttp: true,
            },
            headers: SecurityHeadersConfig {
                xFrameOptions: "DENY",
                xContentTypeOptions: "nosniff",
                xXSSProtection: "1; mode=block",
                strictTransportSecurity: "max-age=31536000",
            },
            inputValidation: InputValidationConfig {
                enabled: true,
                maxRequestSize: 10485760,
                maxArrayLength: 1000,
            },
        },
        wasm: WASMConfig {
            enabled: true,
            target: "wasm32-unknown-unknown",
            optimization: "size",
            features: ["std", "web"],
        },
    };
}

// getEnv - Ruft Umgebungsvariable ab mit Fallback
fn getEnv(key: string, defaultValue: string): string {
    // In Production: return env.get(key) ?? defaultValue;
    // Für Beispiel: Simuliere Umgebungsvariablen
    return defaultValue;
}

// getConfig - Gibt geladene Konfiguration zurück
fn getConfig(): AppConfig {
    if (appConfig == null) {
        appConfig = loadConfig();
    }
    return appConfig;
}

// Initialisiere Config beim Start
appConfig = loadConfig();
